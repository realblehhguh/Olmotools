{% extends "base.html" %}

{% block title %}Deploy Training - OLMo Training Deployer{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header -->
    <div class="text-center mb-8">
        <h1 class="text-4xl font-bold text-gray-900 mb-4">Deploy OLMo Training to Modal</h1>
        <p class="text-lg text-gray-600">Configure and launch your training job with just a few clicks</p>
    </div>

    <!-- Preset Buttons -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <h2 class="text-xl font-semibold mb-4 text-gray-800">
            <i class="fas fa-magic mr-2 text-purple-600"></i>Quick Presets
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <button onclick="setPreset('quick_test')" 
                class="preset-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition duration-300 transform hover:scale-105">
                <i class="fas fa-vial mr-2"></i>Quick Test
                <span class="block text-sm font-normal mt-1">100 samples, 1 epoch</span>
            </button>
            <button onclick="setPreset('full_training')" 
                class="preset-btn bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg transition duration-300 transform hover:scale-105">
                <i class="fas fa-rocket mr-2"></i>Full Training
                <span class="block text-sm font-normal mt-1">Full dataset, 3 epochs</span>
            </button>
            <button onclick="setPreset('custom')" 
                class="preset-btn bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-lg transition duration-300 transform hover:scale-105">
                <i class="fas fa-cog mr-2"></i>Custom
                <span class="block text-sm font-normal mt-1">Configure all parameters</span>
            </button>
        </div>
    </div>

    <!-- Deployment Form -->
    <form id="deploymentForm" action="{{ url_for('deploy') }}" method="POST" class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-semibold mb-6 text-gray-800">
            <i class="fas fa-sliders-h mr-2 text-purple-600"></i>Training Configuration
        </h2>

        <input type="hidden" id="preset" name="preset" value="custom">

        <!-- API Key -->
        <div class="mb-6">
            <label for="api_key" class="block text-sm font-medium text-gray-700 mb-2">
                <i class="fas fa-key mr-1"></i>API Key (Required)
            </label>
            <input type="password" id="api_key" name="api_key" required
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500"
                placeholder="Enter your deployment API key">
            <p class="mt-1 text-xs text-gray-500">Contact admin for API key if you don't have one</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Model Configuration -->
            <div>
                <h3 class="text-lg font-medium mb-4 text-gray-700">
                    <i class="fas fa-brain mr-2"></i>Model Settings
                </h3>
                
                <!-- Model Name -->
                <div class="mb-4">
                    <label for="model_name" class="block text-sm font-medium text-gray-700 mb-2">
                        Model Name
                    </label>
                    <select id="model_name" name="model_name" 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500">
                        <option value="allenai/OLMo-2-1124-7B" selected>OLMo-2-1124-7B (Default)</option>
                        <option value="allenai/OLMo-1B">OLMo-1B (Smaller)</option>
                        <option value="allenai/OLMo-7B">OLMo-7B (Original)</option>
                    </select>
                </div>

                <!-- Run Name -->
                <div class="mb-4">
                    <label for="run_name" class="block text-sm font-medium text-gray-700 mb-2">
                        Run Name (Optional)
                    </label>
                    <input type="text" id="run_name" name="run_name"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500"
                        placeholder="e.g., experiment_v1">
                </div>

                <!-- LoRA -->
                <div class="mb-4">
                    <label class="flex items-center">
                        <input type="checkbox" id="use_lora" name="use_lora" value="true" checked
                            class="mr-2 rounded text-purple-600 focus:ring-purple-500">
                        <span class="text-sm font-medium text-gray-700">Use LoRA (Recommended)</span>
                    </label>
                    <p class="ml-6 text-xs text-gray-500">Parameter-efficient fine-tuning</p>
                </div>

                <!-- 4-bit Quantization -->
                <div class="mb-4">
                    <label class="flex items-center">
                        <input type="checkbox" id="use_4bit" name="use_4bit" value="true"
                            class="mr-2 rounded text-purple-600 focus:ring-purple-500">
                        <span class="text-sm font-medium text-gray-700">Use 4-bit Quantization</span>
                    </label>
                    <p class="ml-6 text-xs text-gray-500">Reduces memory usage</p>
                </div>
            </div>

            <!-- Training Parameters -->
            <div>
                <h3 class="text-lg font-medium mb-4 text-gray-700">
                    <i class="fas fa-chart-line mr-2"></i>Training Parameters
                </h3>

                <!-- Epochs -->
                <div class="mb-4">
                    <label for="num_epochs" class="block text-sm font-medium text-gray-700 mb-2">
                        Number of Epochs: <span id="epochs_value" class="font-bold text-purple-600">3</span>
                    </label>
                    <input type="range" id="num_epochs" name="num_epochs" 
                        min="1" max="10" value="3" 
                        class="w-full"
                        oninput="document.getElementById('epochs_value').textContent = this.value">
                </div>

                <!-- Batch Size -->
                <div class="mb-4">
                    <label for="batch_size" class="block text-sm font-medium text-gray-700 mb-2">
                        Batch Size per GPU
                    </label>
                    <select id="batch_size" name="batch_size" 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500">
                        <option value="2">2 (Low Memory)</option>
                        <option value="4" selected>4 (Balanced)</option>
                        <option value="8">8 (High Memory)</option>
                    </select>
                </div>

                <!-- Learning Rate -->
                <div class="mb-4">
                    <label for="learning_rate" class="block text-sm font-medium text-gray-700 mb-2">
                        Learning Rate
                    </label>
                    <input type="number" id="learning_rate" name="learning_rate" 
                        value="0.00002" step="0.000001" min="0.000001" max="0.001"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500">
                </div>

                <!-- Max Length -->
                <div class="mb-4">
                    <label for="max_length" class="block text-sm font-medium text-gray-700 mb-2">
                        Max Sequence Length
                    </label>
                    <select id="max_length" name="max_length" 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500">
                        <option value="512">512</option>
                        <option value="1024">1024</option>
                        <option value="2048" selected>2048</option>
                        <option value="4096">4096</option>
                    </select>
                </div>

                <!-- Sample Size -->
                <div class="mb-4">
                    <label for="train_sample_size" class="block text-sm font-medium text-gray-700 mb-2">
                        Training Sample Size (Optional)
                    </label>
                    <input type="number" id="train_sample_size" name="train_sample_size" 
                        min="1" placeholder="Leave empty for full dataset"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500">
                    <p class="mt-1 text-xs text-gray-500">Number of samples to use (empty = full dataset)</p>
                </div>
            </div>
        </div>

        <!-- GPU Configuration -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h3 class="text-lg font-medium mb-4 text-gray-700">
                <i class="fas fa-microchip mr-2"></i>GPU Configuration
            </h3>
            
            <!-- GPU Recommendations -->
            <div class="mb-6">
                <h4 class="text-sm font-medium text-gray-700 mb-3">Quick GPU Presets</h4>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                    <button type="button" onclick="setGPUPreset('budget')" 
                        class="gpu-preset-btn bg-blue-500 hover:bg-blue-600 text-white text-sm font-medium py-2 px-3 rounded transition duration-300">
                        <i class="fas fa-dollar-sign mr-1"></i>Budget
                        <span class="block text-xs font-normal">L4:1</span>
                    </button>
                    <button type="button" onclick="setGPUPreset('balanced')" 
                        class="gpu-preset-btn bg-green-500 hover:bg-green-600 text-white text-sm font-medium py-2 px-3 rounded transition duration-300">
                        <i class="fas fa-balance-scale mr-1"></i>Balanced
                        <span class="block text-xs font-normal">A100:2</span>
                    </button>
                    <button type="button" onclick="setGPUPreset('performance')" 
                        class="gpu-preset-btn bg-orange-500 hover:bg-orange-600 text-white text-sm font-medium py-2 px-3 rounded transition duration-300">
                        <i class="fas fa-rocket mr-1"></i>Performance
                        <span class="block text-xs font-normal">H100:4</span>
                    </button>
                    <button type="button" onclick="setGPUPreset('maximum')" 
                        class="gpu-preset-btn bg-red-500 hover:bg-red-600 text-white text-sm font-medium py-2 px-3 rounded transition duration-300">
                        <i class="fas fa-fire mr-1"></i>Maximum
                        <span class="block text-xs font-normal">B200:8</span>
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- GPU Type -->
                <div>
                    <label for="gpu_type" class="block text-sm font-medium text-gray-700 mb-2">
                        GPU Type
                    </label>
                    <select id="gpu_type" name="gpu_type" 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500"
                        onchange="updateGPUCountLimit()">
                        <option value="T4">T4 - Basic GPU (16GB)</option>
                        <option value="L4">L4 - Mid-range GPU (48GB)</option>
                        <option value="A10">A10 - Training GPU (24GB)</option>
                        <option value="A100" selected>A100 - High-end GPU (40GB)</option>
                        <option value="A100-40GB">A100-40GB - High-end GPU (40GB)</option>
                        <option value="A100-80GB">A100-80GB - High-end GPU (80GB)</option>
                        <option value="L40S">L40S - High-end GPU</option>
                        <option value="H100">H100 - Latest GPU (80GB)</option>
                        <option value="H100i">H100i - Inference optimized (80GB)</option>
                        <option value="H200">H200 - Flagship GPU (80GB+)</option>
                        <option value="B200">B200 - Most powerful GPU (Blackwell)</option>
                    </select>
                </div>

                <!-- GPU Count -->
                <div>
                    <label for="gpu_count" class="block text-sm font-medium text-gray-700 mb-2">
                        Number of GPUs: <span id="gpu_count_value" class="font-bold text-purple-600">2</span>
                    </label>
                    <input type="range" id="gpu_count" name="gpu_count" 
                        min="1" max="8" value="2" 
                        class="w-full"
                        oninput="updateGPUCountDisplay()">
                    <div class="flex justify-between text-xs text-gray-500 mt-1">
                        <span>1</span>
                        <span id="gpu_count_max">8</span>
                    </div>
                </div>
            </div>

            <!-- GPU Info Display -->
            <div id="gpu_info" class="mt-4 p-3 bg-gray-50 rounded-lg">
                <div class="text-sm text-gray-600">
                    <strong>Configuration:</strong> <span id="gpu_config_display">A100:2</span><br>
                    <strong>Total GPU Memory:</strong> <span id="gpu_memory_display">~80GB</span><br>
                    <strong>Use Case:</strong> <span id="gpu_use_case_display">Good balance of performance and cost</span>
                </div>
            </div>
        </div>

        <!-- Resource Information -->
        <div class="bg-gray-50 rounded-lg p-4 mb-6">
            <h3 class="text-sm font-medium text-gray-700 mb-2">
                <i class="fas fa-info-circle mr-2"></i>Resource Information
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm text-gray-600">
                <div>
                    <i class="fas fa-microchip mr-1"></i>
                    <strong>GPUs:</strong> <span id="resource_gpu_display">2x NVIDIA A100</span>
                </div>
                <div>
                    <i class="fas fa-memory mr-1"></i>
                    <strong>Memory:</strong> 32GB RAM
                </div>
                <div>
                    <i class="fas fa-clock mr-1"></i>
                    <strong>Timeout:</strong> 24 hours
                </div>
            </div>
        </div>

        <!-- Submit Button -->
        <div class="flex justify-center">
            <button type="submit" id="deployBtn"
                class="gradient-btn text-white font-bold py-3 px-8 rounded-lg text-lg">
                <i class="fas fa-rocket mr-2"></i>Deploy Training
            </button>
        </div>
    </form>

    <!-- Loading Modal -->
    <div id="loadingModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-lg bg-white">
            <div class="text-center">
                <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-24 w-24 mx-auto mb-4"></div>
                <h3 class="text-lg font-bold text-gray-900">Deploying Training Job...</h3>
                <p class="text-gray-600 mt-2">Please wait while we submit your job to Modal</p>
            </div>
        </div>
    </div>
</div>

<script>
// GPU configuration data
const gpuData = {
    'T4': { memory: 16, maxCount: 8, description: 'Basic GPU for inference and light training' },
    'L4': { memory: 48, maxCount: 8, description: 'Mid-range GPU with good price/performance' },
    'A10': { memory: 24, maxCount: 4, description: 'Good for training, up to 4 GPUs' },
    'A100': { memory: 40, maxCount: 8, description: 'High-end training GPU' },
    'A100-40GB': { memory: 40, maxCount: 8, description: 'A100 with 40GB memory' },
    'A100-80GB': { memory: 80, maxCount: 8, description: 'A100 with 80GB memory' },
    'L40S': { memory: 48, maxCount: 8, description: 'High-end GPU for training' },
    'H100': { memory: 80, maxCount: 8, description: 'Latest high-end GPU for training' },
    'H100i': { memory: 80, maxCount: 8, description: 'H100 inference optimized' },
    'H200': { memory: 80, maxCount: 8, description: 'Latest flagship GPU' },
    'B200': { memory: 80, maxCount: 8, description: 'Most powerful GPU (Blackwell architecture)' }
};

const gpuRecommendations = {
    'budget': { type: 'L4', count: 1, description: 'Cost-effective for small models' },
    'balanced': { type: 'A100', count: 2, description: 'Good balance of performance and cost' },
    'performance': { type: 'H100', count: 4, description: 'High performance for large models' },
    'maximum': { type: 'B200', count: 8, description: 'Maximum performance for largest models' }
};

function setPreset(preset) {
    // Update hidden preset field
    document.getElementById('preset').value = preset;
    
    // Update form values based on preset
    if (preset === 'quick_test') {
        document.getElementById('num_epochs').value = 1;
        document.getElementById('epochs_value').textContent = 1;
        document.getElementById('batch_size').value = 4;
        document.getElementById('train_sample_size').value = 100;
        document.getElementById('run_name').value = 'quick_test_' + Date.now();
    } else if (preset === 'full_training') {
        document.getElementById('num_epochs').value = 3;
        document.getElementById('epochs_value').textContent = 3;
        document.getElementById('batch_size').value = 4;
        document.getElementById('train_sample_size').value = '';
        document.getElementById('run_name').value = 'full_training_' + Date.now();
    } else {
        // Custom - keep current values
    }
    
    // Update button styles
    document.querySelectorAll('.preset-btn').forEach(btn => {
        btn.classList.remove('ring-4', 'ring-opacity-50');
    });
    event.target.classList.add('ring-4', 'ring-opacity-50');
}

function setGPUPreset(preset) {
    const config = gpuRecommendations[preset];
    if (config) {
        document.getElementById('gpu_type').value = config.type;
        document.getElementById('gpu_count').value = config.count;
        updateGPUCountLimit();
        updateGPUDisplay();
    }
    
    // Update button styles
    document.querySelectorAll('.gpu-preset-btn').forEach(btn => {
        btn.classList.remove('ring-4', 'ring-opacity-50');
    });
    event.target.classList.add('ring-4', 'ring-opacity-50');
}

function updateGPUCountLimit() {
    const gpuType = document.getElementById('gpu_type').value;
    const gpuCountSlider = document.getElementById('gpu_count');
    const maxCountDisplay = document.getElementById('gpu_count_max');
    
    const maxCount = gpuData[gpuType]?.maxCount || 8;
    gpuCountSlider.max = maxCount;
    maxCountDisplay.textContent = maxCount;
    
    // Adjust current value if it exceeds the new maximum
    if (parseInt(gpuCountSlider.value) > maxCount) {
        gpuCountSlider.value = maxCount;
    }
    
    updateGPUDisplay();
}

function updateGPUCountDisplay() {
    const gpuCount = document.getElementById('gpu_count').value;
    document.getElementById('gpu_count_value').textContent = gpuCount;
    updateGPUDisplay();
}

function updateGPUDisplay() {
    const gpuType = document.getElementById('gpu_type').value;
    const gpuCount = parseInt(document.getElementById('gpu_count').value);
    const gpuInfo = gpuData[gpuType];
    
    if (gpuInfo) {
        const totalMemory = gpuInfo.memory * gpuCount;
        const config = `${gpuType}:${gpuCount}`;
        
        document.getElementById('gpu_config_display').textContent = config;
        document.getElementById('gpu_memory_display').textContent = `~${totalMemory}GB`;
        document.getElementById('gpu_use_case_display').textContent = gpuInfo.description;
        document.getElementById('resource_gpu_display').textContent = `${gpuCount}x NVIDIA ${gpuType}`;
    }
}

// Initialize GPU display on page load
document.addEventListener('DOMContentLoaded', function() {
    updateGPUCountLimit();
    updateGPUDisplay();
});

// Form submission handler
document.getElementById('deploymentForm').addEventListener('submit', function(e) {
    // Show loading modal
    document.getElementById('loadingModal').classList.remove('hidden');
    document.getElementById('deployBtn').disabled = true;
});
</script>
{% endblock %}
