{% extends "base.html" %}

{% block title %}Deploy Training - OLMo Training Deployer{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header -->
    <div class="text-center mb-8">
        <h1 class="text-4xl font-bold text-gray-900 mb-4">Deploy OLMo Training to Modal</h1>
        <p class="text-lg text-gray-600">Configure and launch your training job with just a few clicks</p>
    </div>

    <!-- Preset Buttons -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <h2 class="text-xl font-semibold mb-4 text-gray-800">
            <i class="fas fa-magic mr-2 text-purple-600"></i>Quick Presets
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <button onclick="setPreset('quick_test')" 
                class="preset-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition duration-300 transform hover:scale-105">
                <i class="fas fa-vial mr-2"></i>Quick Test
                <span class="block text-sm font-normal mt-1">100 samples, 1 epoch</span>
            </button>
            <button onclick="setPreset('full_training')" 
                class="preset-btn bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg transition duration-300 transform hover:scale-105">
                <i class="fas fa-rocket mr-2"></i>Full Training
                <span class="block text-sm font-normal mt-1">Full dataset, 3 epochs</span>
            </button>
            <button onclick="setPreset('custom')" 
                class="preset-btn bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-lg transition duration-300 transform hover:scale-105">
                <i class="fas fa-cog mr-2"></i>Custom
                <span class="block text-sm font-normal mt-1">Configure all parameters</span>
            </button>
        </div>
    </div>

    <!-- Deployment Form -->
    <form id="deploymentForm" action="{{ url_for('deploy') }}" method="POST" class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-semibold mb-6 text-gray-800">
            <i class="fas fa-sliders-h mr-2 text-purple-600"></i>Training Configuration
        </h2>

        <input type="hidden" id="preset" name="preset" value="custom">

        <!-- API Key -->
        <div class="mb-6">
            <label for="api_key" class="block text-sm font-medium text-gray-700 mb-2">
                <i class="fas fa-key mr-1"></i>API Key (Required)
            </label>
            <input type="password" id="api_key" name="api_key" required
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500"
                placeholder="Enter your deployment API key">
            <p class="mt-1 text-xs text-gray-500">Contact admin for API key if you don't have one</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Model Configuration -->
            <div>
                <h3 class="text-lg font-medium mb-4 text-gray-700">
                    <i class="fas fa-brain mr-2"></i>Model Settings
                </h3>
                
                <!-- Model Name -->
                <div class="mb-4">
                    <label for="model_name" class="block text-sm font-medium text-gray-700 mb-2">
                        Model Name
                    </label>
                    <select id="model_name" name="model_name" 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500">
                        <option value="allenai/OLMo-2-1124-7B" selected>OLMo-2-1124-7B (Default)</option>
                        <option value="allenai/OLMo-1B">OLMo-1B (Smaller)</option>
                        <option value="allenai/OLMo-7B">OLMo-7B (Original)</option>
                    </select>
                </div>

                <!-- Run Name -->
                <div class="mb-4">
                    <label for="run_name" class="block text-sm font-medium text-gray-700 mb-2">
                        Run Name (Optional)
                    </label>
                    <input type="text" id="run_name" name="run_name"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500"
                        placeholder="e.g., experiment_v1">
                </div>

                <!-- LoRA -->
                <div class="mb-4">
                    <label class="flex items-center">
                        <input type="checkbox" id="use_lora" name="use_lora" value="true" checked
                            class="mr-2 rounded text-purple-600 focus:ring-purple-500">
                        <span class="text-sm font-medium text-gray-700">Use LoRA (Recommended)</span>
                    </label>
                    <p class="ml-6 text-xs text-gray-500">Parameter-efficient fine-tuning</p>
                </div>

                <!-- 4-bit Quantization -->
                <div class="mb-4">
                    <label class="flex items-center">
                        <input type="checkbox" id="use_4bit" name="use_4bit" value="true"
                            class="mr-2 rounded text-purple-600 focus:ring-purple-500">
                        <span class="text-sm font-medium text-gray-700">Use 4-bit Quantization</span>
                    </label>
                    <p class="ml-6 text-xs text-gray-500">Reduces memory usage</p>
                </div>
            </div>

            <!-- Training Parameters -->
            <div>
                <h3 class="text-lg font-medium mb-4 text-gray-700">
                    <i class="fas fa-chart-line mr-2"></i>Training Parameters
                </h3>

                <!-- Epochs -->
                <div class="mb-4">
                    <label for="num_epochs" class="block text-sm font-medium text-gray-700 mb-2">
                        Number of Epochs: <span id="epochs_value" class="font-bold text-purple-600">3</span>
                    </label>
                    <input type="range" id="num_epochs" name="num_epochs" 
                        min="1" max="10" value="3" 
                        class="w-full"
                        oninput="document.getElementById('epochs_value').textContent = this.value">
                </div>

                <!-- Batch Size -->
                <div class="mb-4">
                    <label for="batch_size" class="block text-sm font-medium text-gray-700 mb-2">
                        Batch Size per GPU
                    </label>
                    <select id="batch_size" name="batch_size" 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500">
                        <option value="2">2 (Low Memory)</option>
                        <option value="4" selected>4 (Balanced)</option>
                        <option value="8">8 (High Memory)</option>
                    </select>
                </div>

                <!-- Learning Rate -->
                <div class="mb-4">
                    <label for="learning_rate" class="block text-sm font-medium text-gray-700 mb-2">
                        Learning Rate
                    </label>
                    <input type="number" id="learning_rate" name="learning_rate" 
                        value="0.00002" step="0.000001" min="0.000001" max="0.001"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500">
                </div>

                <!-- Max Length -->
                <div class="mb-4">
                    <label for="max_length" class="block text-sm font-medium text-gray-700 mb-2">
                        Max Sequence Length
                    </label>
                    <select id="max_length" name="max_length" 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500">
                        <option value="512">512</option>
                        <option value="1024">1024</option>
                        <option value="2048" selected>2048</option>
                        <option value="4096">4096</option>
                    </select>
                </div>

                <!-- Sample Size -->
                <div class="mb-4">
                    <label for="train_sample_size" class="block text-sm font-medium text-gray-700 mb-2">
                        Training Sample Size (Optional)
                    </label>
                    <input type="number" id="train_sample_size" name="train_sample_size" 
                        min="1" placeholder="Leave empty for full dataset"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500">
                    <p class="mt-1 text-xs text-gray-500">Number of samples to use (empty = full dataset)</p>
                </div>
            </div>
        </div>

        <!-- Resource Information -->
        <div class="bg-gray-50 rounded-lg p-4 mb-6">
            <h3 class="text-sm font-medium text-gray-700 mb-2">
                <i class="fas fa-info-circle mr-2"></i>Resource Information
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm text-gray-600">
                <div>
                    <i class="fas fa-microchip mr-1"></i>
                    <strong>GPUs:</strong> 2x NVIDIA A100
                </div>
                <div>
                    <i class="fas fa-memory mr-1"></i>
                    <strong>Memory:</strong> 32GB RAM
                </div>
                <div>
                    <i class="fas fa-clock mr-1"></i>
                    <strong>Timeout:</strong> 24 hours
                </div>
            </div>
        </div>

        <!-- Submit Button -->
        <div class="flex justify-center">
            <button type="submit" id="deployBtn"
                class="gradient-btn text-white font-bold py-3 px-8 rounded-lg text-lg">
                <i class="fas fa-rocket mr-2"></i>Deploy Training
            </button>
        </div>
    </form>

    <!-- Loading Modal -->
    <div id="loadingModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-lg bg-white">
            <div class="text-center">
                <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-24 w-24 mx-auto mb-4"></div>
                <h3 class="text-lg font-bold text-gray-900">Deploying Training Job...</h3>
                <p class="text-gray-600 mt-2">Please wait while we submit your job to Modal</p>
            </div>
        </div>
    </div>
</div>

<script>
function setPreset(preset) {
    // Update hidden preset field
    document.getElementById('preset').value = preset;
    
    // Update form values based on preset
    if (preset === 'quick_test') {
        document.getElementById('num_epochs').value = 1;
        document.getElementById('epochs_value').textContent = 1;
        document.getElementById('batch_size').value = 4;
        document.getElementById('train_sample_size').value = 100;
        document.getElementById('run_name').value = 'quick_test_' + Date.now();
    } else if (preset === 'full_training') {
        document.getElementById('num_epochs').value = 3;
        document.getElementById('epochs_value').textContent = 3;
        document.getElementById('batch_size').value = 4;
        document.getElementById('train_sample_size').value = '';
        document.getElementById('run_name').value = 'full_training_' + Date.now();
    } else {
        // Custom - keep current values
    }
    
    // Update button styles
    document.querySelectorAll('.preset-btn').forEach(btn => {
        btn.classList.remove('ring-4', 'ring-opacity-50');
    });
    event.target.classList.add('ring-4', 'ring-opacity-50');
}

// Form submission handler
document.getElementById('deploymentForm').addEventListener('submit', function(e) {
    // Show loading modal
    document.getElementById('loadingModal').classList.remove('hidden');
    document.getElementById('deployBtn').disabled = true;
});
</script>
{% endblock %}
